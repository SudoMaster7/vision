<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle por Gestos - Vis√£o Computacional</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .video-container {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            background-color: #000;
            min-height: 480px; /* Altura m√≠nima garantida */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .video-container img {
            width: 100%;
            height: auto;
            max-height: 480px;
            object-fit: contain;
        }
        .response-container {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            background-color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 480px; /* Altura m√≠nima garantida */
        }
        .response-container img {
            width: 100%;
            height: auto;
            max-height: 480px;
            object-fit: contain;
            padding: 10px;
        }
        .status-card {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .gesture-badge {
            font-size: 1.5rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container">
            <span class="navbar-brand mb-0 h1">üñêÔ∏è Vis√£o Computacional - Controle por Gestos</span>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <!-- Coluna do V√≠deo (Webcam) -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="card-title mb-0">C√¢mera em Tempo Real</h5>
                    </div>
                    <div class="card-body p-0 video-container">
                        <img src="{{ url_for('video_feed') }}" alt="Feed da Webcam">
                    </div>
                </div>
            </div>

            <!-- Coluna da Resposta (Imagem) -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title mb-0">A√ß√£o / Resposta</h5>
                    </div>
                    <div class="card-body p-0 response-container">
                        <img id="responseImage" src="{{ url_for('static', filename='images/neutro.jpg') }}" alt="Resposta do Gesto">
                    </div>
                </div>
            </div>
        </div>

        <!-- Status e Controles -->
        <div class="row">
            <div class="col-12">
                <div class="status-card text-center">
                    <h3>Status: <span id="gestureName" class="badge bg-info text-dark">Aguardando...</span></h3>
                    <p class="text-muted mt-2">Gestos: M√£o Aberta, Punho Fechado, OK, Joinha, Paz e Amor.<br>Express√µes: Sorriso, Surpresa.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Fun√ß√£o para atualizar a imagem de resposta e o texto do gesto sem recarregar a p√°gina
        setInterval(function() {
            fetch('/current_status')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // Atualizar texto do gesto
                    const gestureElement = document.getElementById('gestureName');
                    if (data.gesto) {
                        gestureElement.innerText = data.gesto;
                    } else {
                        gestureElement.innerText = "Processando...";
                    }
                    
                    // Atualizar imagem de resposta
                    const imgElement = document.getElementById('responseImage');
                    // Adiciona timestamp para evitar cache do navegador
                    const newSrc = "/static/images/" + data.imagem + "?t=" + new Date().getTime();
                    
                    // Verifica se a imagem atual √© diferente da nova (ignorando timestamp)
                    const currentSrcBase = imgElement.src.split('?')[0];
                    const newSrcBase = newSrc.split('?')[0];

                    // Se a imagem mudou OU se a imagem atual est√° quebrada (alt text vis√≠vel), tenta carregar
                    if (!currentSrcBase.endsWith(data.imagem) || imgElement.naturalWidth === 0) {
                        imgElement.src = newSrc;
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar status:', error);
                    document.getElementById('gestureName').innerText = "Erro de Conex√£o";
                });
        }, 500); // Atualiza a cada 500ms (mais suave)
        
        // Tratamento de erro de imagem
        document.getElementById('responseImage').onerror = function() {
            console.log("Erro ao carregar imagem: " + this.src);
            // Tenta carregar a imagem neutra se falhar
            if (!this.src.includes('neutro.jpg')) {
                this.src = "/static/images/neutro.jpg";
            }
        };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>